<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Simple Location Form</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        padding: 20px;
    }
    .container {
        max-width: 450px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label {
        display: block;
        margin-top: 15px;
        font-weight: bold;
    }
    input, textarea, button {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
    }
    button {
        margin-top: 20px;
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
    }
    button:hover {
        background: #0056b3;
    }
    .output {
        margin-top: 20px;
        background: #eef;
        padding: 10px;
        border-radius: 5px;
        font-size: 14px;
    }
</style>
</head>

<body>

<div class="container">
    <h2>Shop Submission Form</h2>

    <form id="myForm">
        <label>Upload Image *</label>
        <input type="file" id="image" accept="image/*" required>

        <label>Description (Optional)</label>
        <textarea id="description" rows="3"></textarea>

        <label>Contact Number *</label>
        <input type="tel" id="contact" placeholder="10-digit number" required>

        <button type="submit">Submit</button>
    </form>

    <div class="output" id="output">Waiting for location…</div>
</div>

<script>
let latitude = null;
let longitude = null;
let address = "Fetching address...";
let compressedImageBlob = null;

// ---------------- LOCATION ----------------
window.onload = () => {
    navigator.geolocation.getCurrentPosition(
        pos => {
            latitude = pos.coords.latitude;
            longitude = pos.coords.longitude;
            reverseGeocode(latitude, longitude);
        },
        () => alert("Location permission denied."),
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
};

// ---------------- REVERSE GEOCODING ----------------
function reverseGeocode(lat, lon) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`)
        .then(res => res.json())
        .then(data => {
            const addr = data.address || {};
            address =
                data.name ||
                addr.university ||
                addr.college ||
                addr.amenity ||
                data.display_name ||
                "Address not found";
        });
}

// ---------------- IMAGE COMPRESSION ----------------
document.getElementById("image").addEventListener("change", async function () {
    const file = this.files[0];
    if (!file) return;

    compressedImageBlob = await compressImage(file);
});

// Compress image to < 1MB
function compressImage(file) {
    return new Promise((resolve) => {
        const img = new Image();
        const reader = new FileReader();

        reader.onload = e => {
            img.src = e.target.result;
        };

        img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            const MAX_WIDTH = 1280;
            const scale = Math.min(1, MAX_WIDTH / img.width);

            canvas.width = img.width * scale;
            canvas.height = img.height * scale;

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            let quality = 0.9;

            function tryCompress() {
                canvas.toBlob(blob => {
                    if (blob.size <= 1024 * 1024 || quality <= 0.4) {
                        resolve(blob);
                    } else {
                        quality -= 0.1;
                        tryCompress();
                    }
                }, "image/jpeg", quality);
            }

            tryCompress();
        };

        reader.readAsDataURL(file);
    });
}

// ---------------- FORM SUBMIT ----------------
document.getElementById("myForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const contact = document.getElementById("contact").value.trim();

    if (!/^[6-9]\d{9}$/.test(contact)) {
        alert("Enter valid 10-digit Indian mobile number");
        return;
    }

    if (!compressedImageBlob) {
        alert("Image still compressing, please wait...");
        return;
    }

    document.getElementById("output").innerHTML = `
        <strong>Submission Successful ✅</strong><br><br>
        <strong>Date & Time:</strong> ${new Date().toLocaleString()}<br>
        <strong>Latitude:</strong> ${latitude}<br>
        <strong>Longitude:</strong> ${longitude}<br>
        <strong>Nearby Address:</strong> ${address}<br>
        <strong>Compressed Image Size:</strong> ${(compressedImageBlob.size / 1024).toFixed(1)} KB<br>
        <strong>Contact:</strong> ${contact}
    `;
});
</script>

</body>
</html>
